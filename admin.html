<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>JUVO Admin Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    :root {
      --primary: #2a6e4d;
      --primary-light: #34bfa3;
      --surface: #ffffff;
      --accent: #2a6e4d;
      --accent-weak: rgba(42, 110, 77, 0.12);
      --text: #333333;
      --text-muted: #666666;
      --success: #10b981;
      --warning: #f59e0b;
      --border: rgba(42, 110, 77, 0.14);
      --page-bg: #f5f8f6;
      --shadow: rgba(15, 27, 23, 0.08);
    }

    :root[data-theme="dark"] {
      --primary: #34bfa3;
      --primary-light: #7ee2b0;
      --surface: #111b17;
      --accent: #2f7d59;
      --accent-weak: rgba(47, 125, 89, 0.22);
      --text: #f8fafc;
      --text-muted: #8aa0aa;
      --success: #38eca9;
      --warning: #f8c146;
      --border: rgba(255, 255, 255, 0.14);
      --page-bg: #0b1114;
      --shadow: rgba(0, 0, 0, 0.4);
    }

    body {
      margin: 0;
      font-family: 'Inter', 'Segoe UI', Tahoma, sans-serif;
      background: var(--page-bg);
      color: var(--text);
    }

    .btn-sm {
      padding: 0.35rem 0.6rem;
      font-size: 0.75rem;
      border-radius: 6px;
    }

    .btn:hover {
      background: #1f5a3e;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #6b7280;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .theme-toggle {
      inline-size: 36px;
      block-size: 36px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--accent);
      color: #fff;
      border: none;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.2s ease;
      box-shadow: 0 6px 18px var(--shadow);
    }

    .theme-toggle:hover {
      transform: translateY(-1px) scale(1.03);
      background: var(--primary-light);
    }

    .theme-toggle i {
      font-size: 1rem;
    }

    .admin-container {
      max-inline-size: 1400px;
      margin: 0 auto;
      padding: 2rem;
      background: var(--surface);
    }

    .admin-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.5rem;
      padding: 1.25rem 2rem;
      background: linear-gradient(120deg, rgba(42,110,77,0.12), rgba(42,110,77,0.04));
      border-block-end: 1px solid var(--border);
    }

    .admin-title {
      font-size: clamp(1.4rem, 2vw, 1.9rem);
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 12px;
      color: var(--primary);
    }

    .admin-title i {
      font-size: 1.2em;
    }

    .admin-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
    }

    .admin-secret {
      inline-size: clamp(220px, 18vw, 280px);
      padding: 0.55rem 0.75rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 0.95rem;
    }

    .admin-secret:focus {
      outline: none;
      border-color: rgba(42,110,77,0.45);
      box-shadow: 0 0 0 3px rgba(42,110,77,0.16);
    }

    .admin-status {
      max-inline-size: 960px;
      margin: 1.5rem auto 0 auto;
      padding: 0.85rem 1.1rem;
      border-radius: 10px;
      background: rgba(42,110,77,0.1);
      color: #0f3b29;
      display: none;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.95rem;
    }

    .admin-status i { color: var(--primary); }

    .admin-status.error {
      background: rgba(239,68,68,0.12);
      color: #7f1d1d;
    }

    .admin-status.error i { color: #dc2626; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-block-end: 2rem;
    }

    .stat-card {
      background: var(--surface);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 18px 40px var(--shadow);
      border: 1px solid var(--border);
    }

    .stat-title {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-block-end: 0.5rem;
      font-weight: 600;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      margin-block-end: 0.5rem;
    }

    .stat-change {
      font-size: 0.8rem;
      color: var(--success);
    }

    .section {
      background: var(--surface);
      border-radius: 12px;
      padding: 1.5rem;
      margin-block-end: 2rem;
      box-shadow: 0 18px 40px var(--shadow);
      border: 1px solid var(--border);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-block-end: 1.5rem;
      padding-block-end: 1rem;
      border-block-end: 1px solid var(--border);
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text);
    }

    .section-controls {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 0.4rem 0.8rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }

    .filter-btn.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .table-container {
      overflow-x: auto;
      position: relative;
    }

    table {
      inline-size: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th, td {
      padding: 0.75rem;
      text-align: start;
      border-block-end: 1px solid var(--border);
    }

    th {
      background: var(--accent-weak);
      font-weight: 600;
      color: var(--text);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    tr:hover {
      background: var(--accent-weak);
    }

    .row-selected {
      background: rgba(42,110,77,0.12) !important;
      box-shadow: inset 0 0 0 2px rgba(42,110,77,0.35);
    }

    .clickable-row {
      cursor: pointer;
      transition: transform 0.15s ease, background 0.15s ease;
    }

    .clickable-row:active {
      transform: scale(0.996);
    }

    .avatar-pill {
      inline-size: 36px;
      block-size: 36px;
      border-radius: 50%;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(42,110,77,0.12);
      color: var(--primary);
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
    }

    .avatar-pill img {
      inline-size: 100%;
      block-size: 100%;
      object-fit: cover;
    }

    .detail-overlay {
      position: fixed;
      inset: 0;
      background: rgba(4, 21, 16, 0.58);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      z-index: 60;
    }

    .detail-overlay[data-open="true"] {
      display: flex;
    }

    .detail-card {
      inline-size: min(720px, 94vw);
      max-block-size: min(85vh, 720px);
      background: var(--surface);
      color: var(--text);
      border-radius: 18px;
      box-shadow: 0 28px 50px var(--shadow);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
      padding: 1.5rem 1.75rem 1rem;
      border-block-end: 1px solid var(--border);
    }

    .detail-title {
      margin: 0;
      font-size: 1.5rem;
    }

    .detail-body {
      padding: 1.25rem 1.75rem 1.75rem;
      overflow-y: auto;
      display: grid;
      gap: 1.25rem;
    }

    .detail-close {
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 1.4rem;
      cursor: pointer;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.75rem 1.5rem;
    }

    .field-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
      margin-block-end: 0.2rem;
    }

    .field-value {
      font-size: 0.96rem;
      font-weight: 500;
      color: var(--text);
      word-break: break-word;
    }

    .chip-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-block-start: 0.25rem;
    }

    .chip {
      padding: 0.25rem 0.55rem;
      background: var(--accent-weak);
      border-radius: 999px;
      font-size: 0.75rem;
      color: var(--accent);
    }

    .detail-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .detail-section {
      display: grid;
      gap: 0.75rem;
    }

    .detail-user-summary {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .detail-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-block-start: 0.5rem;
    }

    .user-cell,
    .worker-cell {
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
    }

    .user-meta,
    .worker-meta {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .user-meta span,
    .worker-meta span {
      display: inline-block;
      margin-inline-end: 0.4rem;
    }

    .finance-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
    }

    .finance-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      box-shadow: 0 2px 12px var(--shadow);
      display: grid;
      gap: 0.5rem;
    }

    .finance-card h4 {
      margin: 0;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
    }

    .finance-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary);
    }

    .finance-subtext {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .finance-table {
      margin-block-start: 1.5rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
      background: var(--surface);
      box-shadow: 0 12px 28px var(--shadow);
    }

    .finance-table table tbody tr:nth-child(even) {
      background: rgba(42,110,77,0.06);
    }

    .finance-table-section {
      padding: 1.25rem 1.5rem;
    }

    .finance-table-section + .finance-table-section {
      border-block-start: 1px solid var(--border);
    }

    .finance-table-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin: 0 0 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .finance-table-title i {
      color: var(--primary);
    }

    .finance-table table thead {
      background: var(--accent-weak);
    }

    .reply-box {
      display: grid;
      gap: 0.5rem;
      margin-block-start: 0.75rem;
    }

    .reply-box textarea {
      inline-size: 100%;
      min-block-size: 110px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--surface);
      padding: 0.75rem;
      font-family: inherit;
      color: var(--text);
      resize: vertical;
    }

    .reply-box textarea:focus {
      outline: none;
      border-color: rgba(42,110,77,0.4);
      box-shadow: 0 0 0 3px rgba(42,110,77,0.2);
    }

    .empty-inline {
      margin: 0;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    :root[data-theme="dark"] .admin-header {
      background: linear-gradient(120deg, rgba(52,191,163,0.16), rgba(8, 18, 19, 0.82));
    }

    :root[data-theme="dark"] .section,
    :root[data-theme="dark"] .stat-card,
    :root[data-theme="dark"] .contact-detail-panel,
    :root[data-theme="dark"] .finance-card,
    :root[data-theme="dark"] .detail-card {
      background: #0f1418;
      border-color: rgba(255,255,255,0.08);
    }

    :root[data-theme="dark"] th {
      background: rgba(52,191,163,0.16);
      color: #e8f9f2;
    }

    :root[data-theme="dark"] tr:hover {
      background: rgba(52,191,163,0.11);
    }

    :root[data-theme="dark"] .finance-table table tbody tr:nth-child(even) {
      background: rgba(52,191,163,0.08);
    }

    :root[data-theme="dark"] .finance-value {
      color: #7ee2b0;
    }

    :root[data-theme="dark"] .error {
      background: rgba(220,38,38,0.18);
      color: #fca5a5;
      border: 1px solid rgba(220,38,38,0.3);
    }

    :root[data-theme="dark"] .loading {
      color: var(--text-muted);
    }

    .status-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .status-rejected {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-confirmed {
      background: #d1fae5;
      color: #065f46;
    }

    .status-completed {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-cancelled {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-verified {
      background: #d1fae5;
      color: #065f46;
    }

    .status-paid {
      background: #dcfce7;
      color: #166534;
    }

    .status-failed {
      background: #fee2e2;
      color: #b91c1c;
    }

    .status-new {
      background: #fef3c7;
      color: #92400e;
    }

    .status-read {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-replied {
      background: #d1fae5;
      color: #065f46;
    }

    .status-closed {
      background: #f3f4f6;
      color: #374151;
    }

    .account-type {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .account-member {
      background: #e0f2fe;
      color: #0277bd;
    }

    .account-helper {
      background: #f3e8ff;
      color: #7c3aed;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }

    .error {
      background: #fee2e2;
      color: #991b1b;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }

    .empty-state i {
      font-size: 3rem;
      margin-block-end: 1rem;
      opacity: 0.5;
    }

    .contact-detail-panel {
      margin-block-start: 1rem;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      background: var(--surface);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: none;
    }

    .contact-detail-panel.active {
      display: block;
    }

    .contact-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-block-end: 0.75rem;
    }

    .contact-detail-meta {
      display: grid;
      gap: 0.4rem;
      margin-block-end: 0.75rem;
      font-size: 0.88rem;
      color: var(--text-muted);
    }

    .contact-detail-message {
      background: rgba(42,110,77,0.06);
      border-radius: 10px;
      padding: 0.75rem;
      white-space: pre-wrap;
      line-height: 1.5;
      color: var(--text);
    }

    .badge {
      display: inline-block;
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--accent-weak);
      color: var(--accent);
    }

    .contact-actions-inline {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-block-start: 0.75rem;
    }

    .ghost-table {
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      display: grid;
      place-items: center;
      color: var(--text-muted);
      gap: 0.5rem;
      font-size: 0.95rem;
    }

    .ghost-table i { font-size: 1.6rem; opacity: 0.4; }

    /* Icon styling replacements (no external font dependencies) */
    i[class*="fa-"] {
      font-style: normal;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      inline-size: 1.35em;
      block-size: 1.35em;
      border-radius: 999px;
      background: rgba(42,110,77,0.14);
      color: var(--primary);
      font-size: 0.82em;
      margin-inline-end: 0.4rem;
      line-height: 1;
    }

    .section-title i,
    .admin-status i,
    .detail-close i,
    .finance-table-title i {
      background: transparent;
      inline-size: auto;
      block-size: auto;
      margin-inline-end: 0.5rem;
      font-size: 1.05em;
    }

    .btn i,
    .contact-detail-header i,
    .contact-actions-inline i,
    .detail-actions i {
      inline-size: 1.2em;
      block-size: 1.2em;
      font-size: 0.85em;
      margin-inline-end: 0.35rem;
    }

    .socials i {
      background: rgba(42,110,77,0.12);
      inline-size: 1.4em;
      block-size: 1.4em;
      font-size: 0.85em;
      border-radius: 8px;
    }

    .fa-spin {
      animation: icon-spin 1.1s linear infinite;
    }

    @keyframes icon-spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .fa-shield-alt::before { content: "üõ°"; }
    .fa-moon::before { content: "üåô"; }
    .fa-sun::before { content: "‚òÄ"; }
    .fa-circle-info::before { content: "‚Ñπ"; }
    .fa-triangle-exclamation::before { content: "‚ö†"; }
    .fa-coins::before { content: "ü™ô"; }
    .fa-sync::before { content: "‚ü≥"; }
    .fa-spinner::before { content: "‚è≥"; }
    .fa-users::before { content: "üë•"; }
    .fa-user-check::before { content: "‚úî"; }
    .fa-envelope::before { content: "‚úâ"; }
    .fa-envelope-open::before { content: "üì¨"; }
    .fa-envelope-open-text::before { content: "üìß"; }
    .fa-calendar-check::before { content: "üìÖ"; }
    .fa-calendar-times::before { content: "üìÜ"; }
    .fa-times::before { content: "‚úï"; }
    .fa-check::before { content: "‚úî"; }
    .fa-eye::before { content: "üëÅ"; }
    .fa-paper-plane::before { content: "‚úà"; }
    .fa-reply::before { content: "‚Ü©"; }
  .fa-hand-holding-usd::before { content: "ÔøΩ"; }
  .fa-hand-holding-heart::before { content: "üíù"; }
  .fa-receipt::before { content: "üßæ"; }
  .fa-clipboard-list::before { content: "üóí"; }
  .fa-copy::before { content: "üìã"; }
  .fa-phone::before { content: "‚òé"; }
  .fa-rupee-sign::before { content: "‚Çπ"; }

    .fab.fa-instagram::before { content: "IG"; font-weight: 600; }
    .fab.fa-x-twitter::before { content: "X"; font-weight: 700; }
    .fab.fa-facebook::before { content: "f"; font-weight: 700; }
    .fab.fa-linkedin::before { content: "in"; font-weight: 700; font-size: 0.78em; }

  @media (max-inline-size: 768px) {
      .admin-container {
        padding: 1rem;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .admin-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
        padding-inline: 1rem;
      }
      
      .admin-controls {
        justify-content: space-between;
      }

      .contact-detail-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="admin-header">
    <div class="admin-title">
      <i class="juvo-logo.jpg"></i>
      JUVO Admin Dashboard
    </div>
    <div class="admin-controls">
      <input type="password" id="secret" class="admin-secret" placeholder="Admin Secret" autocomplete="off" />
      <button id="go" class="btn">Load Data</button>
      <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle theme">
        <i class="fas fa-moon"></i>
      </button>
    </div>
  </div>

  <div id="adminStatus" class="admin-status" role="status" aria-live="polite">
    <i class="fas fa-circle-info"></i>
    <span id="adminStatusText">Enter the admin secret to load data.</span>
  </div>

  <div class="admin-container">
    <!-- Stats Overview -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <div class="stat-title">Total Users</div>
        <div class="stat-value" id="totalUsers">-</div>
        <div class="stat-change">Loading...</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Total Bookings</div>
        <div class="stat-value" id="totalBookings">-</div>
        <div class="stat-change">Loading...</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Active Helpers</div>
        <div class="stat-value" id="activeHelpers">-</div>
        <div class="stat-change">Loading...</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Revenue (‚Çπ)</div>
        <div class="stat-value" id="totalRevenue">-</div>
        <div class="stat-change">Loading...</div>
      </div>
    </div>

    <!-- Finance Section -->
    <div class="section" data-section="finance">
      <div class="section-header">
        <div class="section-title">
          <i class="fas fa-coins"></i> Financial Overview
        </div>
        <div class="section-controls">
          <button class="btn btn-secondary" id="refreshFinance">
            <i class="fas fa-sync"></i> Refresh
          </button>
        </div>
      </div>
      <div class="table-container">
        <div id="financeLoading" class="loading">
          <i class="fas fa-spinner fa-spin"></i> Gathering payment analytics...
        </div>
        <div id="financeError" class="error" style="display: none;"></div>
        <div id="financeContent" style="display: none;" aria-live="polite">
          <div class="finance-grid" id="financeSummary"></div>
          <div class="finance-table" id="financeBreakdown"></div>
        </div>
      </div>
    </div>

    <!-- Users Section -->
  <div class="section" data-section="users">
      <div class="section-header">
        <div class="section-title">
          <i class="fas fa-users"></i> Users Management
        </div>
        <div class="section-controls">
          <button class="filter-btn active" data-filter="all">All</button>
          <button class="filter-btn" data-filter="member">Members</button>
          <button class="filter-btn" data-filter="helper">Helpers</button>
          <button class="btn btn-secondary" id="refreshUsers">
            <i class="fas fa-sync"></i> Refresh
          </button>
        </div>
      </div>
      <div class="table-container">
        <div id="usersLoading" class="loading">
          <i class="fas fa-spinner fa-spin"></i> Loading users...
        </div>
        <div id="usersError" class="error" style="display: none;"></div>
        <div id="usersTable" style="display: none;"></div>
        <div id="usersEmpty" class="empty-state" style="display: none;">
          <i class="fas fa-users"></i>
          <h3>No users found</h3>
          <p>Enter admin secret and click "Load Data" to view users</p>
        </div>
      </div>
    </div>

    <!-- Worker Verification Section -->
    <div class="section" data-section="workers">
      <div class="section-header">
        <div class="section-title">
          <i class="fas fa-user-check"></i> Worker Verification
        </div>
        <div class="section-controls">
          <button class="filter-btn active" data-filter="all">All</button>
          <button class="filter-btn" data-filter="pending">Pending</button>
          <button class="filter-btn" data-filter="verified">Verified</button>
          <button class="btn btn-secondary" id="refreshWorkers">
            <i class="fas fa-sync"></i> Refresh
          </button>
        </div>
      </div>
      <div class="table-container">
        <div id="workersLoading" class="loading">
          <i class="fas fa-spinner fa-spin"></i> Loading workers...
        </div>
        <div id="workersError" class="error" style="display: none;"></div>
        <div id="workersTable" style="display: none;"></div>
        <div id="workersEmpty" class="empty-state" style="display: none;">
          <i class="fas fa-users"></i>
          <h3>No workers found</h3>
          <p>No helper accounts need verification at the moment</p>
        </div>
      </div>
    </div>

    <!-- Contact Messages Section -->
    <div class="section" data-section="contacts">
      <div class="section-header">
        <div class="section-title">
          <i class="fas fa-envelope"></i> Contact Messages
        </div>
        <div class="section-controls">
          <button class="filter-btn active" data-filter="all">All</button>
          <button class="filter-btn" data-filter="new">New</button>
          <button class="filter-btn" data-filter="read">Read</button>
          <button class="filter-btn" data-filter="replied">Replied</button>
          <button class="btn btn-secondary" id="refreshContacts">
            <i class="fas fa-sync"></i> Refresh
          </button>
        </div>
      </div>
      <div class="table-container">
        <div id="contactsLoading" class="loading">
          <i class="fas fa-spinner fa-spin"></i> Loading contacts...
        </div>
        <div id="contactsError" class="error" style="display: none;"></div>
        <div id="contactsTable" style="display: none;"></div>
        <div id="contactsEmpty" class="empty-state" style="display: none;">
          <i class="fas fa-envelope-open"></i>
          <h3>No contact messages</h3>
          <p>No contact form submissions yet</p>
        </div>
        <div id="contactDetailPanel" class="contact-detail-panel" aria-live="polite"></div>
      </div>
    </div>

    <!-- Bookings Section -->
    <div class="section" data-section="bookings">
      <div class="section-header">
        <div class="section-title">
          <i class="fas fa-calendar-check"></i> Bookings Management
        </div>
        <div class="section-controls">
          <button class="filter-btn active" data-filter="all">All</button>
          <button class="filter-btn" data-filter="pending">Pending</button>
          <button class="filter-btn" data-filter="confirmed">Confirmed</button>
          <button class="filter-btn" data-filter="completed">Completed</button>
          <button class="btn btn-secondary" id="refreshBookings">
            <i class="fas fa-sync"></i> Refresh
          </button>
        </div>
      </div>
      <div class="table-container">
        <div id="bookingsLoading" class="loading">
          <i class="fas fa-spinner fa-spin"></i> Loading bookings...
        </div>
        <div id="bookingsError" class="error" style="display: none;"></div>
        <div id="bookingsTable" style="display: none;"></div>
        <div id="bookingsEmpty" class="empty-state" style="display: none;">
          <i class="fas fa-calendar-times"></i>
          <h3>No bookings found</h3>
          <p>Enter admin secret and click "Load Data" to view bookings</p>
        </div>
      </div>
    </div>
  </div>

  <div class="detail-overlay" id="detailOverlay" aria-hidden="true">
    <div class="detail-card" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
      <div class="detail-header">
        <h2 class="detail-title" id="detailTitle"></h2>
        <button class="detail-close" id="detailClose" type="button" aria-label="Close details">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="detail-body" id="detailBody"></div>
    </div>
  </div>

  <script>
    let currentData = {
      users: [],
      bookings: [],
      workers: [],
      contacts: [],
      finance: {
        summary: null,
        payments: [],
        earnings: []
      }
    };

    const SECRET_STORAGE_KEY = 'juvo:admin-secret';
    const statusBanner = document.getElementById('adminStatus');
    const statusText = document.getElementById('adminStatusText');
  const workersTableEl = document.getElementById('workersTable');
  const contactsTableEl = document.getElementById('contactsTable');
  const contactDetailPanelEl = document.getElementById('contactDetailPanel');

    (function configureApiBase(){
      if (typeof window === 'undefined' || !window.fetch) return;
      let base = '';
      if (window.API_BASE_URL) base = window.API_BASE_URL;
      else if (window.location && window.location.origin && window.location.origin.indexOf('file:') === 0) base = 'http://localhost:4000';
      window.__apiBase = base;
      const originalFetch = window.fetch.bind(window);
      window.fetch = function(input, init){
        if (typeof input === 'string' && input.charAt(0) === '/') {
          return originalFetch((base || '') + input, init);
        }
  if (typeof Request !== 'undefined' && input instanceof Request && input.url && input.url.charAt(0) === '/') {
          const proxied = new Request((base || '') + input.url, input);
          return originalFetch(proxied, init);
        }
        return originalFetch(input, init);
      };
    })();

    function setStatus(message, tone = 'info') {
      if (!statusBanner || !statusText) return;
      if (!message) {
        statusBanner.style.display = 'none';
        return;
      }
      statusBanner.style.display = 'flex';
      statusBanner.classList.toggle('error', tone === 'error');
      const icon = statusBanner.querySelector('i');
      if (icon) {
        icon.className = tone === 'error' ? 'fas fa-triangle-exclamation' : 'fas fa-circle-info';
      }
      statusText.textContent = message;
    }

    function describeApiBase() {
      if (!window || !window.__apiBase) return '';
      return ` (using ${window.__apiBase})`;
    }

    function initSecretField() {
      const input = document.getElementById('secret');
      if (!input) return;
      const saved = localStorage.getItem(SECRET_STORAGE_KEY) || 'admin123';
      input.value = saved;
      function persistSecret() {
        const value = (input.value || '').trim();
        if (value) {
          localStorage.setItem(SECRET_STORAGE_KEY, value);
        }
      }
      input.addEventListener('input', persistSecret);
      input.addEventListener('change', persistSecret);
    }

    const detailOverlay = document.getElementById('detailOverlay');
    const detailBody = document.getElementById('detailBody');
    const detailTitleEl = document.getElementById('detailTitle');
    const detailCloseBtn = document.getElementById('detailClose');

    function closeDetailPanel() {
      if (!detailOverlay) return;
      detailOverlay.removeAttribute('data-open');
      detailOverlay.setAttribute('aria-hidden', 'true');
      if (detailBody) detailBody.innerHTML = '';
      if (detailTitleEl) detailTitleEl.textContent = '';
    }

    function openDetailPanel(title, bodyHtml) {
      if (!detailOverlay || !detailBody || !detailTitleEl) return;
      detailTitleEl.textContent = title;
      detailBody.innerHTML = bodyHtml;
      detailOverlay.setAttribute('data-open', 'true');
      detailOverlay.setAttribute('aria-hidden', 'false');
    }

    if (detailOverlay && detailCloseBtn) {
      detailCloseBtn.addEventListener('click', closeDetailPanel);
      detailOverlay.addEventListener('click', function(event) {
        if (event.target === detailOverlay) {
          closeDetailPanel();
        }
      });
      window.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
          closeDetailPanel();
        }
      });
    }

    // Theme toggle functionality
    (function(){
      var root = document.documentElement;
      var toggle = document.getElementById('themeToggle');
      if (!toggle) return;

      function applyIcon() {
        var icon = toggle.querySelector('i');
        var dark = root.getAttribute('data-theme') === 'dark';
        if (icon) {
          icon.className = dark ? 'fas fa-sun' : 'fas fa-moon';
        }
        toggle.setAttribute('title', dark ? 'Switch to light theme' : 'Switch to dark theme');
        toggle.setAttribute('aria-label', dark ? 'Switch to light theme' : 'Switch to dark theme');
      }

      var saved = localStorage.getItem('theme');
      if (saved === 'dark') {
        root.setAttribute('data-theme', 'dark');
      } else if (saved === 'light') {
        root.removeAttribute('data-theme');
      }

      toggle.addEventListener('click', function(){
        if (root.getAttribute('data-theme') === 'dark') {
          root.removeAttribute('data-theme');
          localStorage.setItem('theme', 'light');
        } else {
          root.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
        }
        applyIcon();
      });

      applyIcon();
    })();

    const currentFilters = {
      users: 'all',
      workers: 'all',
      contacts: 'all',
      bookings: 'all'
    };

    let selectedContactId = null;
    let selectedUserId = null;
    let selectedWorkerId = null;

    function getAdminSecret() {
      const input = document.getElementById('secret');
      if (!input) return localStorage.getItem(SECRET_STORAGE_KEY) || 'admin123';
      const value = (input.value || '').trim();
      if (value) {
        localStorage.setItem(SECRET_STORAGE_KEY, value);
        return value;
      }
      const fallback = localStorage.getItem(SECRET_STORAGE_KEY) || 'admin123';
      input.value = fallback;
      return fallback;
    }

    async function parseErrorResponse(res, fallbackMessage) {
      try {
        const body = await res.json();
        if (body && body.error) return body.error;
      } catch (_) {
        // ignore parse errors
      }
      return fallbackMessage || `${res.status} ${res.statusText}`;
    }

    function formatContactReason(reason) {
      return {
        elder: 'Need companion/helper',
        errand: 'Errand / transport assistance',
        apply: 'Applying as helper',
        chef: 'Home chef enquiry',
        other: 'Other'
      }[reason] || reason;
    }

    function clearContactDetail() {
      const panel = contactDetailPanelEl;
      if (panel) {
        panel.classList.remove('active');
        panel.innerHTML = '';
      }
      selectedContactId = null;
    }

    async function pingServer() {
      const timeoutController = new AbortController();
      const timeoutId = setTimeout(() => timeoutController.abort(), 6000);
      try {
        const res = await fetch('/health', { cache: 'no-store', signal: timeoutController.signal });
        if (!res.ok) {
          throw new Error(`Server responded with status ${res.status}`);
        }
        return await res.json();
      } catch (error) {
        throw new Error('Unable to reach JUVO server. Start the backend and retry.');
      } finally {
        clearTimeout(timeoutId);
      }
    }

    function formatCurrency(amountInCents) {
      const amount = (Number(amountInCents) || 0) / 100;
      return new Intl.NumberFormat('en-IN', {
        style: 'currency',
        currency: 'INR',
        maximumFractionDigits: 2
      }).format(amount);
    }

    function formatDateTime(value, fallback) {
      if (!value) return fallback || 'N/A';
      const dt = new Date(value);
      if (Number.isNaN(dt.getTime())) return fallback || 'N/A';
      return dt.toLocaleString();
    }

    function formatDate(value, fallback) {
      if (!value) return fallback || 'N/A';
      const dt = new Date(value);
      if (Number.isNaN(dt.getTime())) return fallback || 'N/A';
      return dt.toLocaleDateString();
    }

    function getInitials(source) {
      if (!source) return 'U';
      const cleaned = source.replace(/[^a-zA-Z ]/g, ' ').trim();
      if (!cleaned) return 'U';
      const parts = cleaned.split(/[\s]+/).filter(Boolean);
      if (!parts.length) return 'U';
      if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
      return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
    }

    function renderAvatar(user, size) {
      const dimension = size || 36;
      if (user.avatarUrl) {
        return `<span class="avatar-pill" style="inline-size:${dimension}px; block-size:${dimension}px;"><img src="${user.avatarUrl}" alt="${user.username || user.email || 'User'} avatar"></span>`;
      }
      const initials = getInitials(user.username || user.name || user.email || user.phone || 'User');
      return `<span class="avatar-pill" style="inline-size:${dimension}px; block-size:${dimension}px;">${initials}</span>`;
    }

    // Load data function
    async function loadData() {
      const secret = getAdminSecret();
      if (!secret) {
        setStatus('Enter the admin secret to load data.', 'error');
        return;
      }

      const baseMessage = describeApiBase();
      setStatus(`Connecting to server${baseMessage}‚Ä¶`);
      try {
        await pingServer();
        setStatus(`Server reachable${baseMessage}. Loading dashboard data‚Ä¶`);
      } catch (error) {
        setStatus(error.message, 'error');
        ['users','bookings','workers','contacts'].forEach(section => {
          showError(section, error.message);
        });
        return;
      }

      const headers = { 'x-admin-secret': secret };
      const loaders = [
        fetchUsers(headers),
        fetchBookings(headers),
        fetchWorkers(headers),
        fetchContacts(headers),
        fetchFinance(headers)
      ];

      const results = await Promise.allSettled(loaders);
      updateStats();

      const failures = results.filter(r => r.status === 'rejected');
      if (!failures.length) {
        setStatus(`All data refreshed at ${new Date().toLocaleTimeString()}.`);
      } else {
  const uniqueMessages = [...new Set(failures.map(f => (f.reason && f.reason.message) || 'Section failed'))];
  const errorMsg = uniqueMessages.join(' | ');
        setStatus(`Loaded with issues: ${errorMsg}`, 'error');
      }
    }

    async function fetchUsers(headers) {
      showLoading('users');
      try {
        const res = await fetch('/admin/users', { headers });
        if (!res.ok) {
          const msg = await parseErrorResponse(res, 'Failed to load users');
          throw new Error(res.status === 401 ? 'Unauthorized. Check the admin secret.' : msg);
        }
        const data = await res.json();
        currentData.users = (data.users || []).map(user => ({
          ...user,
          id: user.id != null ? Number(user.id) || user.id : user.id
        }));
        renderUsers();
        return true;
      } catch (error) {
        currentData.users = [];
        showError('users', error.message || 'Failed to load users');
        throw error;
      }
    }

    async function fetchBookings(headers) {
      showLoading('bookings');
      try {
        const res = await fetch('/admin/bookings', { headers });
        if (!res.ok) {
          const msg = await parseErrorResponse(res, 'Failed to load bookings');
          throw new Error(res.status === 401 ? 'Unauthorized. Check the admin secret.' : msg);
        }
        const data = await res.json();
        currentData.bookings = (data.bookings || []).map(booking => ({
          ...booking,
          id: booking.id != null ? Number(booking.id) || booking.id : booking.id,
          memberId: booking.memberId != null ? Number(booking.memberId) || booking.memberId : booking.memberId,
          helperId: booking.helperId != null ? Number(booking.helperId) || booking.helperId : booking.helperId
        }));
        renderBookings();
        return true;
      } catch (error) {
        currentData.bookings = [];
        showError('bookings', error.message || 'Failed to load bookings');
        throw error;
      }
    }

    async function fetchWorkers(headers) {
      showLoading('workers');
      try {
        const res = await fetch('/admin/workers', { headers });
        if (!res.ok) {
          const msg = await parseErrorResponse(res, 'Failed to load workers');
          throw new Error(res.status === 401 ? 'Unauthorized. Check the admin secret.' : msg);
        }
        const data = await res.json();
        currentData.workers = (data.workers || []).map(worker => ({
          ...worker,
          id: worker.id != null ? Number(worker.id) || worker.id : worker.id
        }));
        renderWorkers();
        return true;
      } catch (error) {
        currentData.workers = currentData.users.filter(user => user.accountType === 'helper');
        showError('workers', error.message || 'Failed to load workers');
        renderWorkers();
        throw error;
      }
    }

    async function fetchContacts(headers) {
      showLoading('contacts');
      try {
        const res = await fetch('/contact/admin', { headers });
        if (!res.ok) {
          const msg = await parseErrorResponse(res, 'Failed to load contact messages');
          throw new Error(res.status === 401 ? 'Unauthorized. Check the admin secret.' : msg);
        }
        const data = await res.json();
        currentData.contacts = (data.contacts || []).map(contact => ({
          ...contact,
          id: contact.id != null ? String(contact.id) : contact.id
        }));
        renderContacts();
        return true;
      } catch (error) {
        currentData.contacts = [];
        clearContactDetail();
        showError('contacts', error.message || 'Failed to load contact messages');
        throw error;
      }
    }

    async function fetchFinance(headers) {
      showLoading('finance');
      try {
        const res = await fetch('/admin/finance', { headers });
        if (!res.ok) {
          const msg = await parseErrorResponse(res, 'Failed to load finance analytics');
          throw new Error(res.status === 401 ? 'Unauthorized. Check the admin secret.' : msg);
        }
        const data = await res.json();
        currentData.finance = {
          summary: data.summary || null,
          payments: data.payments || [],
          earnings: data.earnings || []
        };
        renderFinance();
        return true;
      } catch (error) {
        currentData.finance = { summary: null, payments: [], earnings: [] };
        showError('finance', error.message || 'Failed to load finance analytics');
        throw error;
      }
    }

    function showLoading(type) {
      const loading = document.getElementById(type + 'Loading');
      const error = document.getElementById(type + 'Error');
      const table = document.getElementById(type + 'Table');
      const empty = document.getElementById(type + 'Empty');
      const content = document.getElementById(type + 'Content');
      if (loading) loading.style.display = 'block';
      if (error) error.style.display = 'none';
      if (table) table.style.display = 'none';
      if (empty) empty.style.display = 'none';
      if (content) content.style.display = 'none';
    }

    function showError(type, message) {
      const loading = document.getElementById(type + 'Loading');
      const error = document.getElementById(type + 'Error');
      const table = document.getElementById(type + 'Table');
      const empty = document.getElementById(type + 'Empty');
      const content = document.getElementById(type + 'Content');
      if (loading) loading.style.display = 'none';
      if (error) {
        error.style.display = 'block';
        error.textContent = message;
      }
      if (table) table.style.display = 'none';
      if (empty) empty.style.display = 'none';
      if (content) content.style.display = 'none';
    }

    function setFilter(sectionKey, filterValue) {
      if (!sectionKey) return;
      currentFilters[sectionKey] = filterValue;
      switch (sectionKey) {
        case 'users':
          renderUsers();
          break;
        case 'bookings':
          renderBookings();
          break;
        case 'workers':
          renderWorkers();
          break;
        case 'contacts':
          renderContacts();
          break;
        case 'finance':
          renderFinance();
          break;
        default:
          break;
      }
    }

    function renderFinance() {
      const loading = document.getElementById('financeLoading');
      const error = document.getElementById('financeError');
      const content = document.getElementById('financeContent');
      const summaryEl = document.getElementById('financeSummary');
      const breakdownEl = document.getElementById('financeBreakdown');
      if (!content || !summaryEl || !breakdownEl) return;

      if (loading) loading.style.display = 'none';
      if (error) error.style.display = 'none';

      const summary = currentData.finance.summary || {};
      const payments = currentData.finance.payments || [];
      const earnings = currentData.finance.earnings || [];

      const cards = [
        {
          title: 'Total Revenue',
          value: formatCurrency(summary.totalRevenue_cents || 0),
          subtext: `Past 30 days: ${formatCurrency(summary.revenueLast30_cents || 0)}`
        },
        {
          title: 'Pending Invoices',
          value: formatCurrency(summary.pendingRevenue_cents || 0),
          subtext: `${summary.pendingPaymentsCount || 0} awaiting payment`
        },
        {
          title: 'Paid Out to Helpers',
          value: formatCurrency(summary.payoutsPaid_cents || 0),
          subtext: `${summary.paidPayoutsCount || 0} payouts completed`
        },
        {
          title: 'Pending Payouts',
          value: formatCurrency(summary.payoutsPending_cents || 0),
          subtext: `${summary.pendingPayoutsCount || 0} payout requests remaining`
        }
      ];

      summaryEl.innerHTML = cards
        .map(card => `
          <div class="finance-card">
            <h4>${card.title}</h4>
            <div class="finance-value">${card.value}</div>
            <div class="finance-subtext">${card.subtext}</div>
          </div>
        `)
        .join('');

      const paymentRows = payments.slice(0, 8).map(payment => {
        const status = payment.status || 'pending';
        const booking = payment.bookingId != null ? `#${payment.bookingId}` : 'N/A';
        return `
          <tr>
            <td>#${payment.id}</td>
            <td>${booking}</td>
            <td>${formatCurrency(payment.amount_cents)}</td>
            <td><span class="status-badge status-${status}">${status}</span></td>
            <td>${formatDateTime(payment.created_at)}</td>
          </tr>
        `;
      }).join('');

      const earningsRows = earnings.slice(0, 8).map(payout => {
        const status = payout.status || 'pending';
        const workerName = payout.worker?.name || payout.worker?.email || `Worker #${payout.workerId}`;
        return `
          <tr>
            <td>#${payout.id}</td>
            <td>${workerName}</td>
            <td>${formatCurrency(payout.amount_cents)}</td>
            <td><span class="status-badge status-${status}">${status}</span></td>
            <td>${formatDate(payout.payoutDate || payout.created_at)}</td>
          </tr>
        `;
      }).join('');

      breakdownEl.innerHTML = `
        <div class="finance-table-section">
          <h3 class="finance-table-title"><i class="fas fa-receipt"></i> Recent Payments</h3>
          ${payments.length ? `
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Booking</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>${paymentRows}</tbody>
            </table>
          ` : '<p class="empty-inline">No payment records yet.</p>'}
        </div>
        <div class="finance-table-section">
          <h3 class="finance-table-title"><i class="fas fa-hand-holding-usd"></i> Helper Payouts</h3>
          ${earnings.length ? `
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Helper</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Payout Date</th>
                </tr>
              </thead>
              <tbody>${earningsRows}</tbody>
            </table>
          ` : '<p class="empty-inline">No payouts tracked yet.</p>'}
        </div>
      `;

      content.style.display = 'block';
    }

    function renderContacts() {
      const contacts = currentData.contacts || [];
      const filter = currentFilters.contacts;
      const filtered = filter === 'all' ? contacts : contacts.filter(contact => (contact.status || 'new') === filter);
      const container = contactsTableEl;
      if (!container) {
        return;
      }
      const loading = document.getElementById('contactsLoading');
      const empty = document.getElementById('contactsEmpty');

      if (!filtered.length) {
        loading.style.display = 'none';
        container.style.display = 'none';
        empty.style.display = 'block';
        return;
      }

      let html = `
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Email</th>
              <th>Reason</th>
              <th>Summary</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      filtered.forEach(contact => {
        const reasonText = formatContactReason(contact.reason);
        const message = contact.message ? contact.message.trim() : '';
        const summary = message.length > 72 ? `${message.slice(0, 72)}‚Ä¶` : (message || 'No message');
        const created = contact.createdAt ? new Date(contact.createdAt).toLocaleString() : 'N/A';
        const status = contact.status || 'new';
        const contactId = contact.id != null ? String(contact.id) : '';
        const selectedClass = contactId && contactId === selectedContactId ? ' class="row-selected"' : '';

        html += `
          <tr${selectedClass}>
            <td>${contact.id}</td>
            <td><strong>${contact.name}</strong></td>
            <td><a href="mailto:${contact.email}">${contact.email}</a></td>
            <td>${reasonText}</td>
            <td title="${message || 'No message'}">${summary}</td>
            <td><span class="status-badge status-${status}">${status}</span></td>
            <td>${created}</td>
            <td>
              <div class="contact-actions-inline">
                <button class="btn btn-sm contact-action-btn" type="button" data-contact-action="view" data-contact-id="${contactId}" style="background: #2563eb; color: #fff; margin-inline-end: 5px;">
                  <i class="fas fa-eye"></i> View
                </button>
                <button class="btn btn-sm contact-action-btn" type="button" data-contact-action="reply" data-contact-id="${contactId}" style="background: #0ea5e9; color: #fff; margin-inline-end: 5px;">
                  <i class="fas fa-paper-plane"></i> Reply
                </button>
                <button class="btn btn-sm contact-action-btn" type="button" data-contact-action="status" data-contact-status="read" data-contact-id="${contactId}" style="background: #3b82f6; color: white; margin-inline-end: 5px;">
                  <i class="fas fa-check"></i> Read
                </button>
                <button class="btn btn-sm contact-action-btn" type="button" data-contact-action="status" data-contact-status="replied" data-contact-id="${contactId}" style="background: #10b981; color: white; margin-inline-end: 5px;">
                  <i class="fas fa-reply"></i> Replied
                </button>
                <button class="btn btn-sm contact-action-btn" type="button" data-contact-action="status" data-contact-status="closed" data-contact-id="${contactId}" style="background: #6b7280; color: white;">
                  <i class="fas fa-times"></i> Close
                </button>
              </div>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';

      container.innerHTML = html;
      loading.style.display = 'none';
      empty.style.display = 'none';
      container.style.display = 'block';
    }

    if (contactsTableEl) {
      contactsTableEl.addEventListener('click', onContactsTableClick);
    }

    function onContactsTableClick(event) {
      const button = event.target.closest('button[data-contact-action]');
      if (!button || !contactsTableEl || !contactsTableEl.contains(button)) {
        return;
      }

      event.preventDefault();
      event.stopPropagation();
      const contactId = button.getAttribute('data-contact-id');
      if (!contactId) {
        return;
      }

      const action = button.getAttribute('data-contact-action');
      if (action === 'view') {
        viewContact(contactId);
        return;
      }
      if (action === 'reply') {
        replyToContact(contactId);
        return;
      }
      if (action === 'status') {
        const status = button.getAttribute('data-contact-status');
        if (status) {
          updateContactStatus(contactId, status);
        }
      }
    }

    function renderUsers() {
      const users = currentData.users || [];
      const rejectedWorkers = JSON.parse(localStorage.getItem('rejectedWorkers') || '[]');
      
      // Mark users as rejected based on localStorage
      users.forEach(user => {
        if (rejectedWorkers.includes(String(user.id))) {
          user.rejected = true;
          user.isVerified = false;
        }
      });
      
      const filter = currentFilters.users;
      const filtered = filter === 'all' ? users : users.filter(user => (user.accountType || 'member') === filter);
      const container = document.getElementById('usersTable');
      const loading = document.getElementById('usersLoading');
      const empty = document.getElementById('usersEmpty');

      if (!filtered.length) {
        loading.style.display = 'none';
        container.style.display = 'none';
        empty.style.display = 'block';
        return;
      }

      let html = `
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Contact</th>
              <th>Account Type</th>
              <th>Joined</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
      `;

      filtered.forEach(user => {
        const displayName = user.username || user.email || user.phone || 'Unknown';
        const contact = user.email || user.phone || 'N/A';
        const accountType = user.accountType || 'member';
        const joinedDate = user.created_at ? formatDate(user.created_at) : 'N/A';
        const userId = user.id != null ? String(user.id) : 'N/A';
        const location = user.location || 'Location pending';
        const statusLabel = user.rejected ? 'rejected' : (user.isVerified ? 'verified' : 'pending');

        html += `
          <tr class="clickable-row" data-user-id="${userId}">
            <td>
              <div class="user-cell">
                ${renderAvatar(user, 40)}
                <div>
                  <strong>${displayName}</strong>
                  <div class="user-meta">
                    <span>ID: ${userId}</span>
                    <span>${location}</span>
                  </div>
                </div>
              </div>
            </td>
            <td>${contact}</td>
            <td><span class="account-type account-${accountType}">${accountType}</span></td>
            <td>${joinedDate}</td>
            <td><span class="status-badge status-${statusLabel}">${statusLabel}</span></td>
          </tr>
        `;
      });

      html += '</tbody></table>';

      container.innerHTML = html;
      loading.style.display = 'none';
      empty.style.display = 'none';
      container.style.display = 'block';

      container.querySelectorAll('tr[data-user-id]').forEach(row => {
        row.addEventListener('click', function() {
          const userId = this.getAttribute('data-user-id');
          const user = currentData.users.find(u => String(u.id) === String(userId));
          if (user) {
            selectedUserId = String(user.id);
            showUserDetail(user);
          }
        });
      });

      refreshContactDetail();
    }

    function showUserDetail(user) {
      if (!user) return;
      const userId = user.id != null ? String(user.id) : 'N/A';
      selectedUserId = userId;
      const joined = user.created_at ? formatDateTime(user.created_at) : 'N/A';
      const email = user.email || 'Not provided';
      const phone = user.phone || 'Not provided';
      const address = user.address || 'Not provided';
      const location = user.location || 'Not provided';
      const accountType = (user.accountType || 'member').toUpperCase();
      const statusLabel = user.isVerified ? 'Verified' : 'Pending';
      const profileStatus = user.profileCompleted ? 'Complete' : 'Incomplete';
      const expertise = Array.isArray(user.expertise) ? user.expertise.filter(Boolean) : [];
      const expertiseMarkup = expertise.length
        ? `<div class="chip-list">${expertise.map(skill => `<span class="chip">${skill}</span>`).join('')}</div>`
        : '<div class="field-value">No skills listed yet.</div>';

      const memberBookings = currentData.bookings.filter(booking => String(booking.memberId) === userId);
      const helperBookings = currentData.bookings.filter(booking => String(booking.helperId) === userId);

      openDetailPanel(`User #${userId}`, `
        <div class="detail-section">
          <div class="detail-user-summary">
            ${renderAvatar(user, 60)}
            <div>
              <h3 style="margin:0;">${user.username || user.email || 'User'}</h3>
              <div class="detail-badges">
                <span class="status-badge status-${user.isVerified ? 'verified' : 'pending'}">${statusLabel}</span>
                <span class="status-badge status-confirmed">${accountType}</span>
                <span class="status-badge status-${user.profileCompleted ? 'verified' : 'pending'}">Profile ${profileStatus}</span>
              </div>
            </div>
          </div>
        </div>
        <div class="detail-grid">
          <div>
            <div class="field-label">Joined</div>
            <div class="field-value">${joined}</div>
          </div>
          <div>
            <div class="field-label">Location</div>
            <div class="field-value">${location}</div>
          </div>
          <div>
            <div class="field-label">Email</div>
            <div class="field-value">${email}</div>
          </div>
          <div>
            <div class="field-label">Phone</div>
            <div class="field-value">${phone}</div>
          </div>
        </div>
        <div class="detail-section">
          <div class="field-label">Address</div>
          <div class="field-value">${address}</div>
        </div>
        <div class="detail-section">
          <div class="field-label">Expertise</div>
          ${expertiseMarkup}
        </div>
        <div class="detail-grid">
          <div>
            <div class="field-label">Bookings as Member</div>
            <div class="field-value">${memberBookings.length}</div>
          </div>
          <div>
            <div class="field-label">Bookings as Helper</div>
            <div class="field-value">${helperBookings.length}</div>
          </div>
        </div>
      `);
    }

    function showWorkerDetail(worker) {
      if (!worker) return;
      const workerId = worker.id != null ? String(worker.id) : 'N/A';
      selectedWorkerId = workerId;
      const joined = worker.created_at ? formatDateTime(worker.created_at) : 'N/A';
      const email = worker.email || 'Not provided';
      const phone = worker.phone || 'Not provided';
      const location = worker.location || 'Not provided';
      const isRejected = !!worker.rejected;
      const statusLabel = isRejected ? 'Rejected' : (worker.isVerified ? 'Verified' : 'Pending');
      const expertise = Array.isArray(worker.expertise) ? worker.expertise.filter(Boolean) : [];
      const expertiseMarkup = expertise.length
        ? `<div class="chip-list">${expertise.map(skill => `<span class="chip">${skill}</span>`).join('')}</div>`
        : '<div class="field-value">No specialties shared yet.</div>';
      const helperBookings = currentData.bookings.filter(booking => String(booking.helperId) === workerId);
      const completedBookings = helperBookings.filter(booking => (booking.status || '').toLowerCase() === 'completed');

      const actionButtons = (worker.isVerified || isRejected) ? '' : `
        <div class="detail-actions">
          <button class="btn btn-sm worker-detail-action" type="button" style="background:#10b981; color:#fff;" data-worker-action="verify" data-worker-id="${worker.id}" data-verified="true">
            <i class="fas fa-check"></i> Verify helper
          </button>
          <button class="btn btn-sm worker-detail-action" type="button" style="background:#dc2626; color:#fff;" data-worker-action="reject" data-worker-id="${worker.id}" data-verified="false">
            <i class="fas fa-times"></i> Reject helper
          </button>
        </div>
      `;

      const identityMarkup = worker.identityProof
        ? `<a class="btn btn-sm" style="background:#2563eb; color:#fff;" href="${worker.identityProof}" target="_blank" rel="noopener">View identity proof</a>`
        : '<div class="field-value">Identity proof not uploaded.</div>';

      openDetailPanel(`Helper #${workerId}`, `
        <div class="detail-section">
          <div class="detail-user-summary">
            ${renderAvatar(worker, 60)}
            <div>
              <h3 style="margin:0;">${worker.username || worker.email || 'Worker'}</h3>
              <div class="detail-badges">
                <span class="status-badge status-${worker.isVerified ? 'verified' : 'pending'}">${statusLabel}</span>
                <span class="status-badge status-confirmed">${(worker.accountType || 'helper').toUpperCase()}</span>
              </div>
              ${actionButtons}
            </div>
          </div>
        </div>
        <div class="detail-grid">
          <div>
            <div class="field-label">Joined</div>
            <div class="field-value">${joined}</div>
          </div>
          <div>
            <div class="field-label">Location</div>
            <div class="field-value">${location}</div>
          </div>
          <div>
            <div class="field-label">Email</div>
            <div class="field-value">${email}</div>
          </div>
          <div>
            <div class="field-label">Phone</div>
            <div class="field-value">${phone}</div>
          </div>
        </div>
        <div class="detail-section">
          <div class="field-label">Identity Proof</div>
          ${identityMarkup}
        </div>
        <div class="detail-section">
          <div class="field-label">Expertise</div>
          ${expertiseMarkup}
        </div>
        <div class="detail-grid">
          <div>
            <div class="field-label">Accepted Jobs</div>
            <div class="field-value">${helperBookings.length}</div>
          </div>
          <div>
            <div class="field-label">Completed Jobs</div>
            <div class="field-value">${completedBookings.length}</div>
          </div>
        </div>
      `);
      attachWorkerDetailActions();
    }

    function attachWorkerDetailActions() {
      if (!detailBody) return;
      const buttons = detailBody.querySelectorAll('[data-worker-action][data-worker-id]');
      console.log(`Attaching ${buttons.length} worker detail action buttons`);
      buttons.forEach(button => {
        button.addEventListener('click', function(event) {
          event.preventDefault();
          event.stopPropagation();
          const workerId = this.getAttribute('data-worker-id');
          const shouldVerify = this.getAttribute('data-verified') === 'true';
          const action = shouldVerify ? 'verify' : 'reject';
          console.log(`Worker detail ${action} button clicked for ID: ${workerId}`);
          if (workerId) {
            verifyWorker(workerId, shouldVerify);
          }
        });
      });
    }

    function showContactDetail(contact) {
      const panel = contactDetailPanelEl;
      if (!panel || !contact) {
        clearContactDetail();
        return;
      }

  selectedContactId = contact.id != null ? String(contact.id) : null;
      const reason = formatContactReason(contact.reason);
      const created = contact.createdAt ? new Date(contact.createdAt).toLocaleString() : 'N/A';
      const status = contact.status || 'new';
      const message = contact.message?.trim() || 'No additional message provided.';
  const firstName = (contact.name || '').trim().split(/\s+/)[0] || contact.name || 'there';
  const defaultReply = `Hi ${firstName},\n\nThank you for reaching out to JUVO.\n\nBest regards,\nJUVO Support Team`;

      panel.innerHTML = `
        <div class="contact-detail-header">
          <div>
            <strong>${contact.name}</strong>
            <div class="badge" style="margin-inline-start: 0.35rem;">${reason}</div>
          </div>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button class="btn btn-sm" type="button" data-contact-detail-action="reply" data-contact-id="${selectedContactId}" style="background: #0ea5e9; color: white;">
              <i class="fas fa-paper-plane"></i> Reply
            </button>
            <button class="btn btn-sm" type="button" data-contact-detail-action="status" data-contact-status="read" data-contact-id="${selectedContactId}" style="background: #3b82f6; color: white;">
              <i class="fas fa-check"></i> Mark read
            </button>
            <button class="btn btn-sm" type="button" data-contact-detail-action="status" data-contact-status="replied" data-contact-id="${selectedContactId}" style="background: #10b981; color: white;">
              <i class="fas fa-reply"></i> Replied
            </button>
            <button class="btn btn-sm" type="button" data-contact-detail-action="close" style="background: #6b7280; color: white;">
              <i class="fas fa-times"></i> Close
            </button>
          </div>
        </div>
        <div class="contact-detail-meta">
          <span><strong>Status:</strong> <span class="status-badge status-${status}">${status}</span></span>
          <span><strong>Email:</strong> <a href="mailto:${contact.email}">${contact.email}</a></span>
          <span><strong>Received:</strong> ${created}</span>
        </div>
        <div class="contact-detail-message">${message}</div>
        <div class="reply-box">
          <div class="field-label">Quick reply draft</div>
          <textarea id="reply-${selectedContactId}">${defaultReply}</textarea>
          <div class="detail-actions">
            <button class="btn btn-sm" type="button" style="background:#2563eb; color:#fff;" data-contact-detail-action="send-email" data-contact-id="${selectedContactId}">
              <i class="fas fa-envelope-open"></i> Open email
            </button>
            <button class="btn btn-sm btn-secondary" type="button" data-contact-detail-action="copy-reply" data-contact-id="${selectedContactId}">
              <i class="fas fa-copy"></i> Copy reply
            </button>
          </div>
        </div>
      `;

      panel.classList.add('active');
      attachContactDetailActions(panel);
    }

    function attachContactDetailActions(panel) {
      const target = panel || contactDetailPanelEl;
      if (!target) return;
      target.querySelectorAll('[data-contact-detail-action]').forEach(button => {
        button.addEventListener('click', function(event) {
          event.preventDefault();
          event.stopPropagation();
          const contactId = this.getAttribute('data-contact-id') || selectedContactId;
          const action = this.getAttribute('data-contact-detail-action');
          if (!action) return;

          if (action === 'reply' && contactId) {
            replyToContact(contactId);
            return;
          }
          if (action === 'status' && contactId) {
            const status = this.getAttribute('data-contact-status');
            if (status) {
              updateContactStatus(contactId, status);
            }
            return;
          }
          if (action === 'send-email' && contactId) {
            sendReplyEmail(contactId);
            return;
          }
          if (action === 'copy-reply' && contactId) {
            copyReplyToClipboard(contactId);
            return;
          }
          if (action === 'close') {
            clearContactDetail();
          }
        });
      });
    }

    function refreshContactDetail() {
      if (!selectedContactId) return;
  const contact = currentData.contacts.find(c => String(c.id) === String(selectedContactId));
      if (contact) {
        showContactDetail(contact);
      } else {
        clearContactDetail();
      }
    }

    function viewContact(contactId) {
      const contact = currentData.contacts.find(c => String(c.id) === String(contactId));
      if (!contact) return;
      showContactDetail(contact);
      if (contact.status === 'new') {
        updateContactStatus(contactId, 'read');
      } else {
        renderContacts();
      }
    }

    function replyToContact(contactId) {
      const contact = currentData.contacts.find(c => String(c.id) === String(contactId));
      if (!contact) return;
      if (!selectedContactId || String(selectedContactId) !== String(contactId)) {
        showContactDetail(contact);
      }
      const textarea = document.getElementById(`reply-${contactId}`);
      if (textarea) {
        textarea.focus();
        const len = textarea.value.length;
        textarea.setSelectionRange(len, len);
      }
      setStatus(`Replying to ${contact.name || 'contact'}‚Ä¶`);
    }

    async function copyReplyToClipboard(contactId) {
      const textarea = document.getElementById(`reply-${contactId}`);
      if (!textarea) {
        alert('Reply field not found for this contact.');
        return;
      }
      try {
        await navigator.clipboard.writeText(textarea.value);
        setStatus('Reply copied to clipboard.');
      } catch (error) {
        console.error('Clipboard copy failed', error);
        alert('Unable to copy reply automatically. Please copy the text manually.');
      }
    }

    function sendReplyEmail(contactId) {
      const contact = currentData.contacts.find(c => String(c.id) === String(contactId));
      if (!contact) {
        alert('Contact not found.');
        return;
      }
      const textarea = document.getElementById(`reply-${contactId}`);
      const body = encodeURIComponent((textarea && textarea.value) || '');
      const subject = encodeURIComponent('Response from JUVO Support');
      window.location.href = `mailto:${contact.email}?subject=${subject}&body=${body}`;
      updateContactStatus(contactId, 'replied');
      setStatus(`Opened email client to reply to ${contact.name || 'contact'}.`);
    }

    function renderBookings() {
      const bookings = currentData.bookings || [];
      const filter = currentFilters.bookings;
      const filtered = filter === 'all' ? bookings : bookings.filter(booking => (booking.status || 'pending') === filter);
      const container = document.getElementById('bookingsTable');
      const loading = document.getElementById('bookingsLoading');
      const empty = document.getElementById('bookingsEmpty');

      if (!filtered.length) {
        loading.style.display = 'none';
        container.style.display = 'none';
        empty.style.display = 'block';
        return;
      }

      let html = `
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Service</th>
              <th>Member</th>
              <th>Helper</th>
              <th>Status</th>
              <th>Date</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody>
      `;

      filtered.forEach(booking => {
  const serviceName = booking.service?.title || booking.customServiceTitle || 'Custom Service';
        const memberId = booking.memberId || 'N/A';
        const helperId = booking.helperId || 'N/A';
  const status = booking.status || 'pending';
  const date = booking.scheduled_at ? new Date(booking.scheduled_at).toLocaleDateString() : 'N/A';
  const amountSource = booking.agreedPrice_cents ?? booking.offeredPrice_cents ?? booking.counterOffer_cents;
  const amount = amountSource ? `‚Çπ${((Number(amountSource) || 0) / 100).toFixed(2)}` : 'N/A';

        html += `
          <tr>
            <td>${booking.id}</td>
            <td><strong>${serviceName}</strong></td>
            <td>${memberId}</td>
            <td>${helperId}</td>
            <td><span class="status-badge status-${status}">${status}</span></td>
            <td>${date}</td>
            <td>${amount}</td>
          </tr>
        `;
      });

      html += '</tbody></table>';

      container.innerHTML = html;
      loading.style.display = 'none';
      empty.style.display = 'none';
      container.style.display = 'block';
    }

    function renderWorkers() {
      const workers = currentData.workers || [];
      const rejectedWorkers = JSON.parse(localStorage.getItem('rejectedWorkers') || '[]');
      
      // Mark workers as rejected based on localStorage
      workers.forEach(worker => {
        if (rejectedWorkers.includes(String(worker.id))) {
          worker.rejected = true;
          worker.isVerified = false;
        }
      });
      
      const filter = currentFilters.workers;
      const filtered = workers.filter(worker => {
        const isVerified = !!worker.isVerified;
        const isRejected = !!worker.rejected;
        if (filter === 'all') return true;
        if (filter === 'pending') return !isVerified && !isRejected;
        if (filter === 'verified') return isVerified;
        return true;
      });

      const container = workersTableEl;
      if (!container) {
        return;
      }
      const loading = document.getElementById('workersLoading');
      const empty = document.getElementById('workersEmpty');

      if (!filtered.length) {
        loading.style.display = 'none';
        container.style.display = 'none';
        empty.style.display = 'block';
        return;
      }

      let html = `
        <table>
          <thead>
            <tr>
              <th>Worker</th>
              <th>Contact</th>
              <th>Status</th>
              <th>Joined</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      filtered.forEach(worker => {
        const displayName = worker.username || worker.email || worker.phone || 'Unknown';
        const contact = worker.email || worker.phone || 'N/A';
  const joinedDate = worker.created_at ? formatDate(worker.created_at) : 'N/A';
        const isVerified = !!worker.isVerified;
        const isRejected = !!worker.rejected;
        const status = isRejected ? 'rejected' : (isVerified ? 'verified' : 'pending');
        const workerId = worker.id != null ? String(worker.id) : 'N/A';
        const location = worker.location || 'Location pending';
        const expertise = Array.isArray(worker.expertise) && worker.expertise.length ? worker.expertise.slice(0, 2).join(', ') : 'No specialties yet';

        html += `
          <tr class="clickable-row" data-worker-id="${workerId}">
            <td>
              <div class="worker-cell">
                ${renderAvatar(worker, 40)}
                <div>
                  <strong>${displayName}</strong>
                  <div class="worker-meta">
                    <span>ID: ${workerId}</span>
                    <span>${location}</span>
                    <span>${expertise}</span>
                  </div>
                </div>
              </div>
            </td>
            <td>${contact}</td>
            <td><span class="status-badge status-${status}">${status}</span></td>
            <td>${joinedDate}</td>
            <td>
              ${isRejected ? `
                <span class="status-badge status-rejected">Rejected</span>
              ` : (isVerified ? `
                <span class="status-badge status-verified">Verified</span>
              ` : `
                <button class="btn btn-sm worker-action-btn" type="button" data-worker-action="verify" data-worker-id="${worker.id}" data-verified="true" style="background: #10b981; color: white; margin-inline-end: 5px;">
                  <i class="fas fa-check"></i> Verify
                </button>
                <button class="btn btn-sm worker-action-btn" type="button" data-worker-action="reject" data-worker-id="${worker.id}" data-verified="false" style="background: #dc2626; color: white;">
                  <i class="fas fa-times"></i> Reject
                </button>
              `)}
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';

      container.innerHTML = html;
      loading.style.display = 'none';
      empty.style.display = 'none';
      container.style.display = 'block';
    }

    if (workersTableEl) {
      workersTableEl.addEventListener('click', onWorkersTableClick);
    }

    function onWorkersTableClick(event) {
      const button = event.target.closest('button[data-worker-action]');
      if (button && workersTableEl && workersTableEl.contains(button)) {
        event.preventDefault();
        event.stopPropagation();
        const workerId = button.getAttribute('data-worker-id');
        const shouldVerify = button.getAttribute('data-verified') === 'true';
        const action = shouldVerify ? 'verify' : 'reject';
        console.log(`Worker ${action} button clicked for ID: ${workerId}`);
        if (workerId) {
          verifyWorker(workerId, shouldVerify);
        }
        return;
      }

      const row = event.target.closest('tr[data-worker-id]');
      if (row && workersTableEl && workersTableEl.contains(row)) {
        const workerId = row.getAttribute('data-worker-id');
        if (!workerId) return;
        const worker = currentData.workers.find(w => String(w.id) === String(workerId));
        if (worker) {
          selectedWorkerId = String(worker.id);
          showWorkerDetail(worker);
        }
      }
    }

    async function verifyWorker(workerId, verified) {
      const action = verified ? 'verify' : 'reject';
      const confirmMsg = verified 
        ? `Are you sure you want to VERIFY this worker? They will be marked as verified and can receive jobs.`
        : `Are you sure you want to REJECT this worker? They will be marked as unverified and won't receive priority jobs.`;
      
      if (!confirm(confirmMsg)) {
        return;
      }

      // Show loading state
      setStatus(`${verified ? 'Verifying' : 'Rejecting'} worker...`, 'info');

      try {
        const secret = getAdminSecret();
        const response = await fetch(`/admin/workers/${workerId}/verify`, {
          method: 'POST',
          headers: {
            'x-admin-secret': secret,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ verified })
        });

        if (!response.ok) {
          const errBody = await response.json().catch(() => ({}));
          throw new Error(errBody.error || 'Failed to update worker status');
        }

        const result = await response.json();
        console.log(`Worker ${action} response:`, result);

        const targetId = String(workerId);
        const worker = currentData.workers.find(w => String(w.id) === targetId);
        const userRecord = currentData.users.find(u => String(u.id) === targetId);
        
        // Update worker data
        if (worker) {
          worker.isVerified = verified;
          worker.rejected = !verified; // Mark as rejected if not verified
        }
        
        if (userRecord) {
          userRecord.isVerified = verified;
          userRecord.rejected = !verified; // Mark as rejected if not verified
        }

        // Store rejection status in localStorage to persist across reloads
        const rejectedWorkers = JSON.parse(localStorage.getItem('rejectedWorkers') || '[]');
        if (!verified) {
          // Add to rejected list
          if (!rejectedWorkers.includes(targetId)) {
            rejectedWorkers.push(targetId);
          }
        } else {
          // Remove from rejected list if verified
          const index = rejectedWorkers.indexOf(targetId);
          if (index > -1) {
            rejectedWorkers.splice(index, 1);
          }
        }
        localStorage.setItem('rejectedWorkers', JSON.stringify(rejectedWorkers));

        renderWorkers();
        renderUsers();
        updateStats();
        
        // Clear detail panel after any action
        closeDetailPanel();
        
        const successMsg = verified 
          ? `‚úÖ Worker #${targetId} VERIFIED successfully! They can now receive priority jobs.`
          : `‚ùå Worker #${targetId} REJECTED successfully. Marked as rejected.`;
        
        setStatus(successMsg, 'success');
      } catch (error) {
        console.error('Error verifying worker:', error);
        setStatus(`Failed to ${action} worker: ${error.message || 'Unknown error'}`, 'error');
      }
    }


    async function updateContactStatus(contactId, status) {
      try {
        const secret = getAdminSecret();
        const response = await fetch(`/contact/admin/${contactId}/status`, {
          method: 'PUT',
          headers: {
            'x-admin-secret': secret,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status })
        });

        if (!response.ok) {
          const errBody = await response.json().catch(() => ({}));
          throw new Error(errBody.error || 'Failed to update contact status');
        }

        const targetId = String(contactId);
        const contact = currentData.contacts.find(c => String(c.id) === targetId);
        if (contact) {
          contact.status = status;
        }

        renderContacts();
        refreshContactDetail();
        updateStats();
        setStatus(`Contact #${targetId} marked as ${status}.`);
      } catch (error) {
        console.error('Error updating contact status:', error);
        setStatus(error.message || 'Failed to update contact status. Please try again.', 'error');
      }
    }


    function updateStats() {
      const users = Array.isArray(currentData.users) ? currentData.users : [];
      const bookings = Array.isArray(currentData.bookings) ? currentData.bookings : [];
      const workers = Array.isArray(currentData.workers) ? currentData.workers : [];
      const contacts = Array.isArray(currentData.contacts) ? currentData.contacts : [];

      const totalUsersEl = document.getElementById('totalUsers');
      const totalBookingsEl = document.getElementById('totalBookings');
      const activeHelpersEl = document.getElementById('activeHelpers');
      const totalRevenueEl = document.getElementById('totalRevenue');

      if (totalUsersEl) totalUsersEl.textContent = users.length;
      if (totalBookingsEl) totalBookingsEl.textContent = bookings.length;

      const helpers = users.filter(u => (u.accountType || 'member') === 'helper').length;
      if (activeHelpersEl) activeHelpersEl.textContent = helpers;

      const revenue = bookings
        .filter(b => (b.status || '').toLowerCase() === 'completed' && b.agreedPrice_cents)
        .reduce((sum, b) => {
          const cents = Number(b.agreedPrice_cents) || 0;
          return sum + cents / 100;
        }, 0);
      if (totalRevenueEl) totalRevenueEl.textContent = `‚Çπ${revenue.toFixed(2)}`;

      const userChange = totalUsersEl?.nextElementSibling;
      if (userChange) {
        const membersCount = users.filter(u => (u.accountType || 'member') === 'member').length;
        userChange.textContent = `${membersCount} members ‚Ä¢ ${helpers} helpers`;
      }

      const bookingsChange = totalBookingsEl?.nextElementSibling;
      if (bookingsChange) {
        const pending = bookings.filter(b => (b.status || 'pending') === 'pending').length;
        bookingsChange.textContent = `${pending} pending confirmations`;
      }

      const helpersChange = activeHelpersEl?.nextElementSibling;
      if (helpersChange) {
        const pendingVerifications = workers.filter(w => !w.isVerified).length;
        helpersChange.textContent = `${pendingVerifications} awaiting verification`;
      }

      const revenueChange = totalRevenueEl?.nextElementSibling;
      if (revenueChange) {
        const newContacts = contacts.filter(c => (c.status || 'new') === 'new').length;
        revenueChange.textContent = `${newContacts} new contact${newContacts === 1 ? '' : 's'}`;
      }
    }

    function wireControls() {
      const go = document.getElementById('go');
      const refreshUsers = document.getElementById('refreshUsers');
      const refreshBookings = document.getElementById('refreshBookings');
      const refreshWorkers = document.getElementById('refreshWorkers');
      const refreshContacts = document.getElementById('refreshContacts');
      if (go) go.addEventListener('click', loadData);
      if (refreshUsers) refreshUsers.addEventListener('click', loadData);
      if (refreshBookings) refreshBookings.addEventListener('click', loadData);
      if (refreshWorkers) refreshWorkers.addEventListener('click', loadData);
      if (refreshContacts) refreshContacts.addEventListener('click', loadData);

      const secretInput = document.getElementById('secret');
      if (secretInput) {
        secretInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            loadData();
          }
        });
      }

      document.querySelectorAll('[data-filter]').forEach(btn => {
        btn.addEventListener('click', function() {
          const section = this.closest('.section');
          if (!section) return;
          section.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');

          const filter = this.dataset.filter;
          const sectionKey = section.dataset.section;
          setFilter(sectionKey, filter);
        });
      });
    }

    function bootstrapDashboard() {
      initSecretField();
      wireControls();
      const baseDescriptor = describeApiBase();
  setStatus(`Ready to load data${baseDescriptor}. Click "Load Data" to refresh.`);
      setTimeout(() => {
        loadData();
      }, 120);
    }

    bootstrapDashboard();
  </script>

  <footer class="footer">
    <div class="footer-container">
        <div class="footer-left">
            <h3>JUVO</h3>
            <p>Connecting workers with opportunities that matter.</p>
        </div>

        <div class="footer-center">
            <h4>Quick Links</h4>
            <ul>
                <li><a href="index.html#about">About</a></li>
                <li><a href="index.html#contact">Support</a></li>
                <li><a href="#">Privacy</a></li>
                <li><a href="#">Terms</a></li>
            </ul>
        </div>

        <div class="footer-right">
            <h4>Contact Us</h4>
            <p><i class="fas fa-envelope"></i> support@juvo.in</p>
            <p><i class="fas fa-phone"></i> +91 98765 43210</p>
            <div class="socials">
                <a href="#"><i class="fab fa-instagram"></i></a>
                <a href="#"><i class="fab fa-x-twitter"></i></a>
                <a href="#"><i class="fab fa-facebook"></i></a>
                <a href="#"><i class="fab fa-linkedin"></i></a>
            </div>
        </div>
    </div>

    <div class="footer-bottom">
        ¬© <span id="year"></span> JUVO. Admin Interface.
    </div>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
